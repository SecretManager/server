
파일 복호화 시
1. 회원가입된 회원이라면 2차 비밀번호를 통해 확인 후 복호화

---

암호화 키
- 1. 사용자 별 파일 암호화 키 (개인이 설정)
    - 1-1. 매 파일마다 바꾸어 설정하거나
        - 이때는 파일별로 암호화 키 힌트 값 제공 받아야 함.
        - 파일별로 무슨 암호화 키 사용되었는지는 서버에서 암호화하여 저장하고, 만약 잊었다면 본인인증 기가막히게 해서 가져올 수 있게.
    - 1-2. 파일 암호화 시 공통적으로 사용할 키 설정하거나 (서버에 저장되겠죠?)
    - 1-3. 없이 진행
- 2. 사용자 별 파일 암호화 키 (서버에서 회원가입 시 설정됨)
    - 별도의 수정 불가함.
    - 서버에서만 알고 있음.
    - 로그인 하면 무조건 알아서 설정되나, **로그인 안하면 없이 진행됨**
- 3. 모든 사용자에게 공통으로 적용되는 암호화 키 (서버가 관리)
    - 무조건 해당 값으로 1번 이상은 암호화가 진행됨


암호화 순서
1. 사용자 별 파일 암호화 키(개인)가 있다면 파일 암호화
2. 1의 결과를 사용자 별 파일 암호화 키(서버에서 설정)가 있다면 파일 암호화
3. 2의 결과를 서버의 키로 암호화

비회원의 경우
- 파일 별로 암호화 키를 추가 지정하여 암호화 할 수는 있으나, 복구 불가능

서버 키는 submodule 을 통해 관리함.


---


1. 서버 키 관리
- 서브모듈에서 yml 파일을 통해 키 값을 관리한다.
  - 해당 키 + 파일별 nonce 값 관리를 위해, 파일 암호화 시 사용된 Nonce 값에 대한 정보를 DB 에 저장해야 한다.
  - 해당 키는 서비스 생명주기 내 런칭부터 폐업까지 동일해야 하므로, 별도의 salt 를 사용하지 않고, sha-256 알고리즘을 통해 암호화하여 관리한다.
    - 이미 키가 노출된 경우, 원문은 임의로 정한 값이므로 노출되어도 된다. 따라서 sha-256 알고리즘을 사용해도 된다
      - 사실 암호화 자체를 안 하고 256 바이트만 맞춰도 된다 (어차피 노출되면 복호화 가능). 그러나 sha-256 을 쓰면 간편하게 256 바이트 키가 생성되니 이걸 사용..!
2. 사용자 키 관리 (서버 자체)
   - 사용자 별로 중복되지 않게 임의의 키를 생성하여 관리한다. 해당 키는 서버 자체적으로 임의로 생성되는 값이므로, DB에 바로 저장한다.
   - 파일 암호 시 해당 값을 그대로 사용한다. (이를 위해 알고리즘에 사용되는 키 길이 형식에 맞게 생성되어야 한다.)
   - 원문이 사용자 정보와 관계 없는 랜덤으로 생성되는 값이므로 노출되어도 된다. 따라서, 솔팅, 키 스트레칭등을 사용할 필요 없이 DB 에 키 값을 바로 저장해도 된다.
3. 파일별 키 관리 (사용자 설정 키)
   - 사용자로부터 파일별 암호화 비밀번호(최소 4자리 ~ 최대 100 자리)를 입력받는다.
   - 입력받은 비밀번호를 bycrypt 를 통해 암호화를 진행한다.
     - 해당 비밀번호는 원문이 노출되면 안되므로 sha 대신 더 강력한 bycrypt 혹은 PBKDF2 등의 암호화 알고리즘을 사용한뒤 그 값을 저장한다.

- 파일이 암호화 되는 과정
  - 1. 파일별 키를 통해 암호화
  - 2. 사용자 키를 통해 암호화
  - 3. 서버 키를 통해 암호화
  - 각 암호화 과정에서 각각 nonce를 사용하므로, 각 과정에서 사용된 nonce 값에 대한 정보 역시도 파일별로 관리되어야 한다.


---

- 파일(글, 파일, 이미지 등)의 암호화 방식은 AES - 256 를 사용한다.
  - 대안
      - DES
        - 키 길이: 56비트 (전체 키는 64비트이지만, 8비트는 패리티 비트로 사용되므로 실질적인 키 길이는 56비트).
        - 장점: 빠르다
        - 단점: 키 길이가 짧아, 보안성이 낮다.
      - 3DES (사용 X)
        - 키 길이: 112비트 (두 개의 56비트 키 사용) 또는 168비트 (세 개의 56비트 키 사용).
          - 일반적으로 168비트 키 길이가 사용
        - 장점: DES 보다 강력한 보안
        - 단점: 3번의 DES 연산을 하므로 속도가 느리다. AES 에 비해 보안성이 떨어질 수 있다.
        - 참고 자료 : https://www.cdata.com/blog/3des-vs-aes
      - IDEA
        - 128 비트
        - 단점: 표준으로 널리 채택되지 않았고, AES와 비교하여 사용 사례가 적다.


- 파일 암호화 시 사용되는 키는 각각 다음과 같은 방법으로 생성한다.
  - 1. 서버에서 관리하는 키 -> sha256(지정된 문자열)
  - 2. 각 사용자별로 관리하는 키 -> sha256(사용자 별 임의 uuid)
  - 3. 파일 별로 사용자가 지정하는 키 -> sha256(bcrypt(지정 키))
    - 지정 키는 원문 그대로 저장되면 안되므로 bcrypt(지정 키) 된 값으로 저장한다.

---


사용되는 알고리즘
- AES(256)-GCM : 파일 암호화 시 사용
- SHA256 - AES 알고리즘의 대칭 키 생성 시 사용
- Bcrypt - 사용자의 특정 파일별 지정 키 암호화 시 사용, 사용자 비밀번호 암호화 시 사용

--- 
만약 털린다면...
1. 서버 데이터베이스가 털린다면?
-> 서버에서 관리하는 서버 키가 털리지 않았기 때문에 안전함

2. 서버 키만 털린다면?
-> 파일은 서버 키 뿐만 아니라, 여러 방법으로 암호화되므로 안전함

3. 특정 사용자의 노트북을 뺏어, 파일을 다운로드 받는다면?
-> 1. 파일별로 지정된 암호화 키에 대한 정보가 없으면 해독 불가
-> 2. 만약 특정 파일에 대해 암호화 키를 적용하지 않았더라도, 2차 비밀번호를 통해 방지 가능
